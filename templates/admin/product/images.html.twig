{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des images - {{ product.name }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .image-management-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .media-selector {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .image-item {
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .image-item:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .image-item.main-image {
            border-color: #28a745;
        }
        
        .image-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f8f9fa;
        }
        
        .image-info {
            padding: 0.75rem;
        }
        
        .image-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .btn-group {
            display: flex;
            gap: 0.25rem;
        }
        
        .type-selector {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .media-search {
            margin-bottom: 1rem;
        }
        
        .media-search input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .media-thumbnail {
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .media-thumbnail:hover {
            transform: scale(1.05);
        }
        
        .selected {
            border: 3px solid #007bff !important;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3">Gestion des images</h1>
            <p class="text-muted">Produit: <strong>{{ product.name }}</strong> ({{ product.code }})</p>
        </div>
        <a href="{{ path('admin_product_edit', {id: product.id}) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour au produit
        </a>
    </div>

    <div class="image-management-container">
        <!-- Sélecteur de médias -->
        <div class="media-selector">
            <h4><i class="fas fa-images"></i> Bibliothèque de médias</h4>
            
            <div class="media-search">
                <input type="text" id="mediaSearch" placeholder="Rechercher des médias..." class="form-control">
            </div>
            
            <div class="media-grid" id="mediaGrid">
                <!-- Les médias seront chargés via AJAX -->
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="addSelectedMedia()">
                    <i class="fas fa-plus"></i> Ajouter au produit
                </button>
            </div>
        </div>

        <!-- Images du produit -->
        <div>
            <h4><i class="fas fa-photo-video"></i> Images du produit</h4>
            
            <div class="image-gallery" id="productImageGallery">
                {% for productMedia in product.productMedia %}
                    <div class="image-item {{ productMedia.isMainImage ? 'main-image' }}" data-product-media-id="{{ productMedia.id }}">
                        <img src="{{ asset(productMedia.media.webPath) }}" 
                             alt="{{ productMedia.media.alt }}" 
                             class="image-preview"
                             onerror="this.src='{{ asset('images/placeholder.jpg') }}'">
                        
                        <div class="image-info">
                            <small class="text-muted">{{ productMedia.media.alt }}</small>
                            <div class="image-controls">
                                <select class="type-selector" onchange="updateImageType({{ productMedia.id }}, this.value)">
                                    {% for type, label in media_types %}
                                        <option value="{{ type }}" 
                                                {{ productMedia.mediaType == type ? 'selected' }}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                
                                <div class="btn-group">
                                    <button type="button" 
                                            class="btn btn-sm {{ productMedia.isMainImage ? 'btn-success' : 'btn-outline-success' }}" 
                                            onclick="setMainImage({{ productMedia.id }})"
                                            title="Définir comme image principale">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger" 
                                            onclick="removeImage({{ productMedia.id }})"
                                            title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            {% if product.productMedia is empty %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-image fa-3x mb-3"></i>
                    <p>Aucune image associée à ce produit</p>
                    <p class="small">Utilisez le sélecteur de médias à gauche pour ajouter des images</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        let selectedMediaIds = [];
        
        // Charger les médias
        function loadMedia() {
            const search = document.getElementById('mediaSearch').value;
            const grid = document.getElementById('mediaGrid');
            
            fetch(`/admin/media/list?search=${encodeURIComponent(search)}`)
                .then(response => response.json())
                .then(data => {
                    grid.innerHTML = '';
                    data.medias.forEach(media => {
                        const mediaDiv = document.createElement('div');
                        mediaDiv.innerHTML = `
                            <img src="${media.url}" 
                                 alt="${media.alt}" 
                                 class="media-thumbnail"
                                 data-media-id="${media.id}"
                                 onclick="toggleMediaSelection(${media.id}, this)">
                        `;
                        grid.appendChild(mediaDiv);
                    });
                });
        }
        
        // Sélectionner/désélectionner un média
        function toggleMediaSelection(mediaId, element) {
            if (selectedMediaIds.includes(mediaId)) {
                selectedMediaIds = selectedMediaIds.filter(id => id !== mediaId);
                element.classList.remove('selected');
            } else {
                selectedMediaIds.push(mediaId);
                element.classList.add('selected');
            }
        }
        
        // Ajouter les médias sélectionnés au produit
        function addSelectedMedia() {
            if (selectedMediaIds.length === 0) {
                alert('Veuillez sélectionner au moins un média');
                return;
            }
            
            selectedMediaIds.forEach(mediaId => {
                fetch(`{{ path('admin_product_images', {id: product.id}) }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'add',
                        media_id: mediaId,
                        media_type: 'gallery',
                        is_main_image: false,
                        sort_order: 0
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            });
        }
        
        // Supprimer une image
        function removeImage(productMediaId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette image ?')) {
                fetch(`{{ path('admin_product_images', {id: product.id}) }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'remove',
                        media_id: productMediaId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`[data-product-media-id="${productMediaId}"]`).remove();
                    }
                });
            }
        }
        
        // Définir comme image principale
        function setMainImage(productMediaId) {
            fetch(`{{ path('admin_product_images', {id: product.id}) }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'update',
                    product_media_id: productMediaId,
                    is_main_image: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
        
        // Mettre à jour le type d'image
        function updateImageType(productMediaId, mediaType) {
            fetch(`{{ path('admin_product_images', {id: product.id}) }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'update',
                    product_media_id: productMediaId,
                    media_type: mediaType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Erreur lors de la mise à jour');
                }
            });
        }
        
        // Recherche en temps réel
        document.getElementById('mediaSearch').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(loadMedia, 300);
        });
        
        // Charger les médias au démarrage
        document.addEventListener('DOMContentLoaded', loadMedia);
    </script>
{% endblock %}