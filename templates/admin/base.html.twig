<!DOCTYPE html>
<html lang="{{ app.request.locale }}">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}{{ 'admin.title'|trans({}, 'admin') }} - {{ setting('siteName') }} {% endblock %}</title>
    <link rel="icon" href="{{ asset('images/favicon.png') }}" type="image/png"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    {% block stylesheets %}
        {{ encore_entry_link_tags('admin') }}
    {% endblock %}

    {% block javascripts %}
        {{ encore_entry_script_tags('admin') }}
    {% endblock %}
</head>

<body>
    {# Admin Header #}
    <nav class="navbar navbar-dark admin-header">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="navbar-toggler d-md-none me-3" type="button" onclick="toggleSidebar()">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" href="{{ path('admin_dashboard') }}">
                    <img width="200" src="{{asset('images/logo-light.png') }}" alt="{{setting('siteName')}}">
                </a>
            </div>

            <div class="d-flex align-items-center">
                {# Language Selector #}
                {% if get_languages() is defined and get_languages()|length > 0 %}
                    <div class="dropdown me-3">
                        <button class="btn btn-outline-light dropdown-toggle" type="button"
                                id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                                title="{{ 'language.change_interface'|trans({}, 'admin') }}">
                            <i class="bi bi-translate me-1"></i>
                            <span id="currentLanguageCode">{{ app.request.locale|upper }}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                            {% for language in get_languages() %}
                                <li>
                                    <a class="dropdown-item{{ app.request.locale == language.code ? ' active' : '' }}"
                                       href="{{ path('locale_switch', {'_locale': language.code}) }}">
                                        <span class="badge bg-primary me-2">{{ language.code|upper }}</span>
                                        {{ language.nativeName }}
                                        {% if language.isDefault() %}
                                            <i class="bi bi-star-fill text-warning ms-1"
                                               title="{{ 'language.default.title'|trans({}, 'admin') }}"></i>
                                        {% endif %}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <div class="me-3">
                        <span class="btn btn-outline-light disabled">
                            <i class="bi bi-translate me-1"></i>
                            <span>{{ app.request.locale|upper }}</span>
                        </span>
                    </div>
                {% endif %}

                <button id="themeToggle" class="btn btn-outline-light theme-toggle me-3" type="button"
                        title="{{ 'theme.toggle'|trans({}, 'admin') }}">
                    <i class="bi bi-moon-fill"></i>
                </button>
                <a href="{{ path('app_homepage') }}" class="btn btn-outline-light"
                   title="{{ 'common.actions.view_site'|trans({}, 'admin') }}" target="_blank">
                    <i class="bi bi-eye-fill me-1"></i>{{ 'common.actions.view_site'|trans({}, 'admin') }}
                </a>
            </div>
        </div>
    </nav>

    {# Sidebar #}
    <nav id="adminSidebar" class="admin-sidebar collapse d-md-block">
        <div class="position-sticky pt-3">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') == 'admin_dashboard' %} active{% endif %}"
                       href="{{ path('admin_dashboard') }}">
                        <i class="bi bi-house-fill me-2"></i>{{ 'admin.navigation.dashboard'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_product_' %} active{% endif %}"
                       href="{{ path('admin_product_index') }}">
                        <i class="bi bi-box-seam me-2"></i>{{ 'admin.navigation.products'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_orders' %} active{% endif %}"
                       href="{{ path('admin_orders_index') }}">
                        <i class="bi bi-receipt me-2"></i>{{ 'admin.navigation.orders'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_category_' %} active{% endif %}"
                       href="{{ path('admin_category_index') }}">
                        <i class="bi bi-tags-fill me-2"></i>{{ 'admin.navigation.categories'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_media_' %} active{% endif %}"
                       href="{{ path('admin_media_index') }}">
                        <i class="bi bi-images me-2"></i>{{ 'admin.navigation.medias'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_language_' %} active{% endif %}"
                       href="{{ path('admin_language_index') }}">
                        <i class="bi bi-translate me-2"></i>{{ 'admin.navigation.translations'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_user_' %} active{% endif %}"
                       href="{{ path('admin_user_index') }}">
                        <i class="bi bi-people-fill me-2"></i>{{ 'admin.navigation.users'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_setting' %} active{% endif %}"
                       href="{{ path('admin_setting') }}">
                        <i class="bi bi-gear-fill me-2"></i>{{ 'admin.navigation.settings'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link{% if app.request.get('_route') starts with 'admin_option' %} active{% endif %}"
                       href="{{ path('admin_option_index') }}">
                        <i class="bi bi-list-check me-2"></i>{{ 'admin.navigation.options'|trans({}, 'admin') }}
                    </a>
                </li>
            </ul>

            <hr class="text-white-50">

            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="{{ path('admin_user_profile') }}">
                        <i class="bi bi-person-circle me-2"></i>{{ 'admin.common.profile'|trans({}, 'admin') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ path('app_logout') }}">
                        <i class="bi bi-box-arrow-right me-2"></i>{{ 'admin.common.logout'|trans({}, 'admin') }}
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    {# Main Content #}
    <main class="admin-main">
        <div class="container-fluid py-4">
            {% block body %}{% endblock %}
        </div>
    </main>

    {# Flash messages #}
    {% for type, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ type == 'error' ? 'danger' : type }} alert-dismissible fade show position-fixed"
                 style="top: 60px; right: 20px; z-index: 1040; max-width: 400px;" role="alert">
                <i class="bi bi-{% if type == 'success' %}check-circle{% elseif type == 'error' or type == 'danger' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                {{ message|trans({}, 'admin') }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"
                        aria-label="{{ 'action.close'|trans({}, 'admin') }}"></button>
            </div>
        {% endfor %}
    {% endfor %}

{% block extra_javascripts %}
    <script>
        // Prevent multiple executions
        if (window.adminScriptsLoaded) {
            // Already loaded â€” skip
        } else {
            window.adminScriptsLoaded = true;

            // === ALL YOUR JS BELOW ===
            const getStoredTheme = () => localStorage.getItem("theme");
            const setStoredTheme = theme => localStorage.setItem("theme", theme);

            const getPreferredTheme = () => {
                const storedTheme = getStoredTheme();
                if (storedTheme) return storedTheme;
                return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
            };

            const setTheme = theme => {
                document.documentElement.setAttribute("data-bs-theme", theme);
                const themeToggle = document.querySelector("#themeToggle");
                if (themeToggle) {
                    const icon = themeToggle.querySelector("i");
                    icon.className = theme === "dark" ? "bi bi-sun-fill" : "bi bi-moon-fill";
                }
            };

            // Apply theme on load
            setTheme(getPreferredTheme());

            // Theme toggle
            document.addEventListener("DOMContentLoaded", () => {
                const themeToggle = document.querySelector("#themeToggle");
                if (themeToggle) {
                    themeToggle.addEventListener("click", () => {
                        const currentTheme = document.documentElement.getAttribute("data-bs-theme");
                        const newTheme = currentTheme === "dark" ? "light" : "dark";
                        setStoredTheme(newTheme);
                        setTheme(newTheme);
                    });
                }

                // Sidebar toggle
                window.toggleSidebar = () => {
                    document.querySelector("#adminSidebar").classList.toggle("show");
                };

                // Auto-hide alerts
                document.querySelectorAll(".alert:not(.alert-permanent)").forEach(alert => {
                    setTimeout(() => {
                        const alertInstance = bootstrap.Alert.getInstance(alert) || bootstrap.Alert.getOrCreateInstance(alert);
                        alertInstance?.close() || alert.remove();
                    }, 5000);
                });
            });

            // Confirm delete (modal version recommended, but this works)
            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll("button[data-bs-toggle=\"modal\"][data-action=\"delete\"]").forEach(btn => {
                    btn.addEventListener("click", function () {
                        const itemName = this.dataset.itemName || "{{ 'common.item'|trans({}, 'admin') }}";
                        if (confirm(`{{ 'common.confirm.delete'|trans({'%item%': ''}, 'admin') }}${itemName} ?`)) {
                            const form = document.querySelector(this.dataset.target);
                            if (form) form.submit();
                        }
                    });
                });
            });
        }
    </script>
    
{% endblock %}
</body>
</html>